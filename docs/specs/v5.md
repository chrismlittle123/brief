# Brief - V5 Specification

> Fill in the gaps, keep it brief.

V5 builds on the [V4 spec](./v4.md) with a Slack app integration that brings check-in reminders, one-tap voice sessions, and report delivery directly into Slack.

## New Features

### 1. Slack App (Replaces Webhook)

Upgrade the shame bot from a text-only incoming webhook to a proper Slack app with Block Kit messages, interactive buttons, and DMs.

**What changes:**

- Replace the Slack incoming webhook with a Slack app (bot token + signing secret)
- The shame bot message now includes a "Start Check-in" button
- Clicking the button opens the voice agent session in the browser
- The URL contains a signed token so the user is authenticated automatically (no login screen)

**Slack app setup:**

- Bot token scopes: `chat:write`, `users:read`, `users:read.email`
- The app posts to a team channel (like today's shame bot) and/or sends DMs
- Escalation levels remain (GENTLE, MEDIUM, FULL_ROAST) — the message copy changes but the button is always present

### 2. Slack-Initiated Check-in Flow

**Slack message format:**

```
┌─────────────────────────────────────────────┐
│  Hey Chris, time for your weekly update.     │
│                                              │
│  It takes ~3 minutes — just talk through     │
│  what you've been up to.                     │
│                                              │
│  [ Start Check-in ]  ← opens voice session   │
└─────────────────────────────────────────────┘
```

The button URL: `https://brief.progression-labs.ai/call/[sessionId]?token=[signedToken]`

**DM flow:**

In addition to channel messages, the bot sends a direct message to each team member who hasn't submitted:

```
┌─────────────────────────────────────────────┐
│  Hey Chris — quick reminder to submit your   │
│  weekly update.                              │
│                                              │
│  [ Start Check-in ]                          │
└─────────────────────────────────────────────┘
```

This is more effective on mobile — the user gets a Slack notification, taps it, taps the button, and they're talking to the agent.

**When all team members have submitted**, the celebration message is posted to the channel (no button needed).

**Slack WebView handling:**

- If Slack's in-app browser blocks WebRTC, show a "Open in browser" fallback link immediately

### 3. Signed Token Authentication

When a user clicks the Slack button, they should land in the voice session immediately — no login screen.

**How it works:**

1. When the shame bot generates a message for a specific user, it creates a signed JWT containing:
   - `sub`: user email
   - `name`: user display name
   - `team`: team identifier
   - `sessionId`: unique session ID for this check-in
   - `weekOf`: the Monday date for this update
   - `exp`: expiry (24 hours)

2. The JWT is signed with a server-side secret (`BRIEF_SESSION_SECRET`)

3. The URL includes the token: `https://brief.progression-labs.ai/call/[sessionId]?token=[jwt]`

4. When the page loads, the backend:
   - Verifies the JWT signature and expiry
   - Extracts user identity (no Clerk session needed)
   - Creates a LiveKit room and generates a LiveKit participant token
   - Returns the LiveKit connection details to the frontend

5. The frontend connects to LiveKit and the conversation begins

**Fallback:** If the token is expired or invalid, redirect to the normal Clerk login flow, then back to the session.

**Security considerations:**

- Tokens are single-use per session (sessionId is unique)
- 24-hour expiry prevents stale links from being reused
- The JWT secret is separate from other app secrets
- Tokens are generated server-side only — never exposed to the client before the Slack message

### 4. Comms Receiver — Report Delivery

Reports aren't just saved to Notion. The people who need to read them — managers, leads, CEOs — get them delivered via Slack in the format they prefer.

**Slack delivery to receivers:**

When a team member saves their report, the Slack app posts to a configured channel (or DMs specific receivers) with two consumption options:

```
┌──────────────────────────────────────────────────┐
│  Weekly Update — Chris Little                     │
│  Week of Jan 27, 2025 · Status: On Track         │
│                                                    │
│  TL;DR: Shipped the onboarding flow and resolved  │
│  the API latency issue. Client demo went well.    │
│                                                    │
│  [ Read Full Report ]    [ Listen to Podcast ]    │
└──────────────────────────────────────────────────┘
```

**Option 1: Read Full Report (signed URL)**

- Button opens `https://brief.progression-labs.ai/report/[reportId]?token=[signedToken]`
- Signed token grants read-only access — no login required
- Clean, formatted page showing the full structured report
- Token expires after 7 days

**Option 2: Listen as Podcast (audio version)**

- Button opens `https://brief.progression-labs.ai/report/[reportId]/listen?token=[signedToken]`
- The report is pre-rendered as audio using TTS (generated when the report is saved)
- Minimal player UI with:
  - Play / pause
  - Playback speed: **1x / 1.5x / 2x / 3x**
  - Progress bar
  - Duration (typically 60–90 seconds)
- Works inline on mobile — the receiver can listen while commuting, walking, etc.

**Audio generation:**

- When a report is saved, the backend generates an audio file using OpenAI TTS (or ElevenLabs)
- The script is a natural narration of the report, not a robotic reading of bullet points:

  > *"Chris's update for the week of January 27th. The big wins this week were shipping the new onboarding flow and resolving the API latency issue. The client demo on Wednesday went well — stakeholders are feeling positive. One challenge: the design review from Jon is still pending, which could slow down next week's work. Looking ahead, the priorities are..."*

- Audio is stored as a static file (S3 / Vercel Blob / R2) and served via CDN
- Generated once per report, cached permanently

**Receiver configuration:**

- Receivers are configured per team (e.g., "send Chris's updates to #leadership and DM to faycal@progression-labs.ai")
- Configurable in the Brief admin or via environment variable initially:

```
BRIEF_RECEIVERS=channel:#leadership,dm:faycal@progression-labs.ai,dm:jon@progression-labs.ai
```

**Digest mode (optional, future):**

Instead of one message per report, receivers can opt into a weekly digest — a single Slack message on Monday morning with all team updates, and a combined podcast that reads through everyone's update back-to-back with transitions:

> *"Here are the team updates for the week of January 27th. Starting with Chris..."*

This is noted as a future enhancement — V5 ships with individual report delivery.

## Updated Architecture

```
┌──────────────┐     ┌──────────────────┐     ┌─────────────────┐
│  Slack App   │────→│  Brief Backend    │────→│  LiveKit Cloud  │
│  (Bot)       │←────│  (Fastify API)    │     │  (WebRTC SFU)   │
└──────────────┘     └──────────────────┘     └─────────────────┘
   ↑  sends to            │                         │
   │  receivers            │                         ↕
   │                       │                  ┌─────────────────┐
   │                       │                  │  LiveKit Agent   │
   │                       │                  │  (Python)        │
   │                       │                  │  ├── STT         │
   │                       │                  │  ├── LLM         │
   │                       │                  │  └── TTS         │
   │                       │                  └─────────────────┘
   │                       │
   │                ┌──────┼───────┐
   │                │      │       │
   │          ┌─────┴──┐ ┌─┴────┐ ┌┴───────────┐
   │          │ Notion │ │OpenAI│ │ Audio Store │
   │          │ (save) │ │(LLM) │ │ (S3/R2)    │
   │          └────────┘ └──────┘ └────────────┘
   │                        │
   │                   TTS for podcast
   │                   narration
   └───────────────────────────────────────────
```

**Flow:**

```
1. Shame bot sends Slack message/DM with signed URL + "Start Check-in" button
2. User taps button → browser opens /call/[sessionId]?token=[jwt]
3. Backend verifies token, creates LiveKit room, returns connection info
4. Voice agent session runs (V3 flow: interview → review → edit → save)
5. Report saved to Notion
6. Backend generates podcast audio (TTS narration of report)
7. Slack app sends report to configured receivers (read link + podcast link)
```

## New API Routes

| Route | Method | Purpose |
|-------|--------|---------|
| `/api/slack/notify` | POST | Send check-in reminders via Slack app (replaces shame-bot webhook) |
| `/api/slack/deliver` | POST | Send completed report to configured receivers via Slack |
| `/api/report/[reportId]` | GET | Fetch report for read-only viewer (signed token auth) |
| `/api/report/[reportId]/audio` | POST | Generate podcast audio from a saved report (TTS narration) |
| `/api/report/[reportId]/audio` | GET | Stream the generated podcast audio file |

Routes removed:

| Route | Reason |
|-------|--------|
| `/api/shame-bot` | Replaced by `/api/slack/notify` |
| `/api/transcribe` | No longer needed — LiveKit agent handles STT in real-time |

Routes unchanged:

| Route | Notes |
|-------|-------|
| All V3/V4 session routes | Unchanged |
| `/api/generate-report` | Unchanged |
| `/api/refine-report` | Unchanged |
| `/api/save-to-notion` | Unchanged |

## New Pages

| Route | Purpose |
|-------|---------|
| `/report/[reportId]` | Read-only report viewer for receivers (signed token auth) |
| `/report/[reportId]/listen` | Podcast player for receivers (signed token auth) |

Existing pages (V1–V4) remain as alternative input methods.

## Mobile Experience (Slack-initiated)

The Slack → voice agent flow is designed to work well on phones:

1. **Notification**: User gets a Slack DM notification
2. **One tap**: Opens Slack, sees the message
3. **Second tap**: Taps "Start Check-in" button
4. **Browser opens**: `/call/[sessionId]?token=[jwt]` loads
5. **Mic permission**: Browser prompts for microphone (one-time)
6. **Talking**: Agent greets them, conversation starts
7. **Done**: Report appears, tap "Save to Notion"

## New Environment Variables

| Variable | Purpose | New/Changed/Removed |
|----------|---------|---------------------|
| `BRIEF_SESSION_SECRET` | JWT signing secret for session tokens | New |
| `SLACK_BOT_TOKEN` | Slack app bot token (replaces webhook) | New |
| `SLACK_SIGNING_SECRET` | Slack request signature verification | New |
| `SLACK_WEBHOOK_URL` | _(removed)_ | Removed |
| `AUDIO_STORAGE_BUCKET` | S3/R2 bucket for podcast audio files | New |
| `AUDIO_STORAGE_ACCESS_KEY` | Storage access key | New |
| `AUDIO_STORAGE_SECRET_KEY` | Storage secret key | New |
| `BRIEF_RECEIVERS` | Receiver config (channel:#leadership,dm:user@co.com) | New |
| All V3/V4 variables | Unchanged | - |

## Updated User Flow

**Slack-initiated (primary V5 flow):**

1. Shame bot sends Slack message/DM with "Start Check-in" button
2. User taps button → browser opens voice session (signed token, no login)
3. Agent asks 4 questions conversationally (~3 min)
4. Report is generated from conversation
5. Agent reads report back at user's chosen speed (1x / 1.5x / 2x)
6. User edits by voice until satisfied
7. User says "save it" → report saved to Notion
8. Podcast audio generated from report
9. Slack app delivers report to receivers (read link + podcast link)

**Receiver experience:**

1. Manager/CEO gets Slack message with report summary
2. Taps "Read Full Report" → signed URL opens formatted report (no login)
3. Or taps "Listen to Podcast" → audio player with speed controls (1x / 1.5x / 2x / 3x)
