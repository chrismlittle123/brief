# Brief - V2 Specification

> Fill in the gaps, keep it brief.

V2 builds on the [V1 spec](./v1.md) with Google-based authentication and Google Calendar integration.

## New Features

### 1. Login with Google (via Clerk)

Replace the current email-whitelist authentication with Google OAuth powered by Clerk, using `@clerk/nextjs`.

**What changes:**

- Remove the existing email + cookie auth system (`/api/auth/login`, `ALLOWED_EMAILS` env var, `brief_user_email` cookie)
- Integrate [Clerk](https://clerk.com) as the authentication provider with Google as a social login option
- Use `@clerk/nextjs` for both frontend UI and backend route protection

**Frontend:**

- Replace the `/login` page with Clerk's `<SignIn />` component (Google OAuth button)
- Wrap the app with `<ClerkProvider>`
- Use `useAuth()` / `useUser()` hooks for session state and user info (name, email, avatar)

**Backend / API routes:**

- Use `clerkMiddleware()` from `@clerk/nextjs/server` in Next.js middleware for route protection
- Use `auth()` and `currentUser()` helpers in API route handlers to get user identity
- All protected routes validate the Clerk session automatically
- Public routes (landing page, health check) remain unauthenticated
- User identity (email, name) derived from Clerk session — no more cookie parsing

**Environment variables added:**

| Variable | Purpose |
|----------|---------|
| `NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY` | Clerk frontend key |
| `CLERK_SECRET_KEY` | Clerk backend key |

**Environment variables removed:**

| Variable | Reason |
|----------|--------|
| `ALLOWED_EMAILS` | Replaced by Clerk's user management / organization allowlist |

### 2. Google Calendar Integration (Friday Reminder)

Brief automatically creates a 15-minute Google Calendar event each week to remind the user to submit their weekly update.

**Behaviour:**

- After a user logs in (or on a weekly schedule), Brief creates a 15-minute Google Calendar event titled **"Brief - Weekly Update"** on the upcoming Friday
- The event is scheduled **before 12:00 midday UK time** (Europe/London timezone)
- Brief checks the user's existing Friday calendar for conflicts and finds the first available 15-minute slot that does not clash with existing events
- The slot search window is **09:00 – 12:00 UK time** on Friday
- If no free slot exists before midday, no event is created and the user is notified
- The event includes a description with a direct link to the Brief check-in page
- Events are only created if one doesn't already exist for that Friday (idempotent)

**Implementation:**

- Request the `https://www.googleapis.com/auth/calendar` and `https://www.googleapis.com/auth/calendar.events` OAuth scopes via Clerk's Google OAuth configuration
- Use the Google Calendar API (v3) via the `googleapis` npm package
- Use the user's Google OAuth access token (obtained from Clerk) to authenticate Calendar API requests

**API routes added:**

| Route | Method | Purpose |
|-------|--------|---------|
| `/api/calendar/schedule-reminder` | POST | Find a free slot on Friday and create the reminder event |
| `/api/calendar/status` | GET | Check if a reminder is already scheduled for this week |

**Free slot algorithm:**

1. Query Google Calendar FreeBusy API for the user's Friday between 09:00 and 12:00 (Europe/London)
2. Build a list of occupied intervals
3. Walk from 09:00 in 15-minute increments, find the first slot with no overlap
4. Create a 15-minute event in that slot

**Calendar event details:**

- **Title**: "Brief - Weekly Update"
- **Duration**: 15 minutes
- **Description**: "Time to fill in your weekly Brief update.\n\n[Open Brief](https://brief.progression-labs.ai/checkin)"
- **Reminders**: Default (popup 10 minutes before)
- **Colour**: App brand colour (if supported)

**Environment variables added:**

| Variable | Purpose |
|----------|---------|
| `GOOGLE_CLIENT_ID` | Google OAuth client ID (for Calendar API) |
| `GOOGLE_CLIENT_SECRET` | Google OAuth client secret |

## Updated Tech Stack (changes from V1)

- **Auth**: Clerk (Google OAuth) via `@clerk/nextjs`
- **Calendar**: Google Calendar API v3 via `googleapis`

## Updated User Flow

1. **Landing Page** (`/`): Welcome with feature cards and CTA buttons
2. **Login** (`/login`): Sign in with Google via Clerk
3. **Calendar Sync**: Brief schedules a Friday reminder in the user's Google Calendar (if not already set)
4. **Choose Input Method**: Voice or Text
5. **Record/Enter Responses**: Answer 4 questions
6. **Review & Edit**: Check transcript/responses, re-record if needed
7. **AI Report Generation**: System generates structured report
8. **Refine** (optional): Make corrections via natural language
9. **Save to Notion**: One-click save with success confirmation
10. **View in Notion**: Link to open newly created page

## Updated API Routes

All V1 routes remain (with auth mechanism changed). New routes:

| Route | Method | Purpose |
|-------|--------|---------|
| `/api/calendar/schedule-reminder` | POST | Create Friday reminder event |
| `/api/calendar/status` | GET | Check if reminder exists for this week |

Routes removed:

| Route | Reason |
|-------|--------|
| `/api/auth/login` | Replaced by Clerk |
| `/api/auth/logout` | Replaced by Clerk |

Route unchanged:

| Route | Notes |
|-------|-------|
| `/api/auth/me` | Now returns Clerk user data instead of cookie email |

## Updated Environment Variables

| Variable | Purpose | New/Changed/Removed |
|----------|---------|---------------------|
| `NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY` | Clerk frontend key | New |
| `CLERK_SECRET_KEY` | Clerk backend key | New |
| `GOOGLE_CLIENT_ID` | Google OAuth client ID | New |
| `GOOGLE_CLIENT_SECRET` | Google OAuth client secret | New |
| `ALLOWED_EMAILS` | _(removed)_ | Removed |
| `OPENAI_API_KEY` | Unchanged | - |
| `NOTION_API_KEY` | Unchanged | - |
| `NOTION_DATABASE_ID` | Unchanged | - |
| `SLACK_WEBHOOK_URL` | Unchanged | - |
